<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ðŸ–¤ Zine Forum Wall</title>

  <!-- ZINE FONTS -->
  <link href="https://fonts.googleapis.com/css2?family=Special+Elite&family=Space+Mono&display=swap" rel="stylesheet">

  <!-- STYLES -->
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <!-- TITLE -->
  <h1>ðŸ–¤ ZINE WALL</h1>

  <!-- DARK MODE TOGGLE -->
  <button id="toggle">ðŸ–¤ Dark Zine Mode</button>

  <!-- AUTH SECTION -->
  <div id="auth">
    <input id="email" type="email" placeholder="email" />
    <input id="password" type="password" placeholder="password" />
    <button onclick="signUp()">Sign Up</button>
    <button onclick="logIn()">Log In</button>
  </div>

  <!-- FORUM SECTION -->
  <div id="forum" hidden>
    <p id="user"></p>

    <input id="title" placeholder="post title" />
    <textarea id="content" rows="4" placeholder="paste your thoughts here..."></textarea>
    <button onclick="addPost()">POST</button>

    <!-- WALL -->
    <div id="wall"></div>
  </div>

  <!-- SCRIPT -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script type="module" src="script.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const toggle = document.getElementById("toggle");

    if (!toggle) {
      console.warn("Dark mode toggle button not found");
      return;
    }

    toggle.addEventListener("click", () => {
      document.body.classList.toggle("dark");
      console.log("Dark mode toggled");
    });
  });
</script>

</body>
</html>
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;

  const { data, error } = await supabase.auth.signInWithPassword({ email, password });
  if (error) return alert(error.message);
}

// =========================
//  AUTH STATE HANDLER
// =========================
supabase.auth.onAuthStateChange(async (event, session) => {
  if (session && session.user) {
    authDiv.hidden = true;
    forum.hidden = false;
    userText.textContent = "Logged in as: " + session.user.email;
    loadPosts();
    subscribePosts();
  } else {
    authDiv.hidden = false;
    forum.hidden = true;
    userText.textContent = "";
  }
});

// =========================
//  ADD POST
// =========================
async function addPost() {
  const titleEl = document.getElementById("title");
  const contentEl = document.getElementById("content");
  const user = await supabase.auth.getUser();
  const email = user.data.user.email;

  if (!titleEl.value || !contentEl.value) return;

  const { data, error } = await supabase
    .from("posts")
    .insert([{ title: titleEl.value, content: contentEl.value, user_email: email }]);

  if (error) return alert(error.message);

  titleEl.value = "";
  contentEl.value = "";
}

// =========================
//  LOAD POSTS (initial)
async function loadPosts() {
  const { data, error } = await supabase
    .from("posts")
    .select("*")
    .order("inserted_at", { ascending: false });

  if (error) return console.error(error);

  wall.innerHTML = "";
  data.forEach(post => {
    createPostCard(post);
  });
}

// =========================
//  REALTIME SUBSCRIPTION
// =========================
function subscribePosts() {
  supabase
    .from("posts")
    .on("INSERT", payload => {
      createPostCard(payload.new, true);
    })
    .subscribe();
}

// =========================
//  CREATE POST CARD
// =========================
function createPostCard(post, prepend = false) {
  const card = document.createElement("div");
  card.className = "card";

  // Random rotation
  const rotation = (Math.random() * 4 - 2).toFixed(2);
  card.style.transform = `rotate(${rotation}deg)`;

  card.innerHTML = `
    <div class="sticker">${randomSticker()}</div>
    <h3>${post.title}</h3>
    <p>${post.content}</p>
    <small>${post.user_email}</small>
  `;

  if (prepend && wall.firstChild) {
    wall.insertBefore(card, wall.firstChild);
  } else {
    wall.appendChild(card);
  }
}

// =========================
//  EXPOSE FUNCTIONS TO GLOBAL
// =========================
window.signUp = signUp;
window.logIn = logIn;
window.addPost = addPost;
